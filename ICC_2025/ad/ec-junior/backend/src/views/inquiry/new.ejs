<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Inquiry - EC Junior</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="/public/js/pow.js"></script>
    <script src="/public/js/pow-wrapper.js"></script>
</head>
<body>
    <%- include('../partials/header', { user }) %>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2>Submit Inquiry</h2>

                <% if (errors.length > 0) { %>
                    <div class="alert alert-danger">
                        <% errors.forEach(error => { %>
                            <div><%= error %></div>
                        <% }); %>
                    </div>
                <% } %>

                <div class="card">
                    <div class="card-body">
                        <form method="post" action="/inquiry/new" id="inquiryForm">
                            <input type="hidden" name="challenge" value="<%= challenge %>">
                            <input type="hidden" name="nonce" id="nonce" value="">

                            <div class="mb-3">
                                <label for="inquiryType" class="form-label">Inquiry Type</label>
                                <select class="form-select" id="inquiryType" name="inquiryType" onchange="toggleProductSelect()">
                                    <option value="general">General Inquiry</option>
                                    <option value="restock">Product Restock Request</option>
                                </select>
                            </div>

                            <div class="mb-3" id="productSelectDiv" style="display: none;">
                                <label for="productId" class="form-label">Product</label>
                                <select class="form-select" id="productId" name="productId">
                                    <option value="">-- Select a product --</option>
                                    <% products.forEach(product => { %>
                                        <option value="<%= product.id %>"><%= product.name %> (Stock: <%= product.stock %>)</option>
                                    <% }); %>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject</label>
                                <input type="text" class="form-control" id="subject" name="subject" required>
                            </div>

                            <div class="mb-3">
                                <label for="message" class="form-label">Message</label>
                                <textarea class="form-control" id="message" name="message" rows="8" required></textarea>
                            </div>

                            <div id="powStatus" class="alert alert-info" style="display: none;">
                                <strong>Computing proof of work...</strong>
                                <div class="progress mt-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>
                                <small id="powAttempts" class="text-muted"></small>
                            </div>

                            <button type="submit" class="btn btn-primary" id="submitBtn">Submit Inquiry</button>
                            <a href="/" class="btn btn-secondary">Cancel</a>
                        </form>
                    </div>
                </div>

                <script>
                    function toggleProductSelect() {
                        const inquiryType = document.getElementById('inquiryType').value;
                        const productSelectDiv = document.getElementById('productSelectDiv');
                        if (inquiryType === 'restock') {
                            productSelectDiv.style.display = 'block';
                        } else {
                            productSelectDiv.style.display = 'none';
                        }
                    }

                    const form = document.getElementById('inquiryForm');
                    const submitBtn = document.getElementById('submitBtn');
                    const powStatus = document.getElementById('powStatus');
                    const attemptsDisplay = document.getElementById('powAttempts');
                    let isComputing = false;

                    form.addEventListener('submit', async (e) => {
                        if (isComputing) {
                            return;
                        }

                        const nonceInput = document.getElementById('nonce');
                        if (nonceInput.value) {
                            return;
                        }

                        e.preventDefault();
                        isComputing = true;
                        submitBtn.disabled = true;
                        powStatus.style.display = 'block';

                        try {
                            const challenge = document.querySelector('input[name="challenge"]').value;
                            console.log('[Form] Starting PoW with challenge:', challenge);

                            const nonce = await window.powSolver.solvePoW(challenge, (attempts) => {
                                attemptsDisplay.textContent = `Attempts: ${attempts.toLocaleString()}`;
                            });

                            console.log('[Form] PoW solved! Nonce:', nonce);
                            nonceInput.value = nonce;
                            powStatus.style.display = 'none';
                            submitBtn.disabled = false;
                            isComputing = false;

                            form.submit();
                        } catch (error) {
                            console.error('[Form] PoW failed:', error);
                            alert('Failed to compute proof of work: ' + error.message);
                            powStatus.style.display = 'none';
                            submitBtn.disabled = false;
                            isComputing = false;
                        }
                    });
                </script>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>
</body>
</html>
